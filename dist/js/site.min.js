var site=angular.module("site",["ui.router","firebase"]);site.config(function(e,t){t.otherwise("/"),e.state("home",{url:"/",templateUrl:"views/home.html",controller:"LoginController"}).state("search",{url:"/search",templateUrl:"views/search.html",controller:"SearchController"}).state("profile",{url:"/profile",templateUrl:"views/profile.html"}).state("countdown",{url:"/countdown",templateUrl:"views/countdown.html",controller:"CountdownController"}).state("result",{url:"/result",templateUrl:"views/result.html",controller:"ResultController"})}),site.controller("siteCtrl",["$scope","$window","$state",function(e,t,o){e.gotoProfile=function(){o.go("")},$(document).ready(function(){})}]),site.controller("LoginController",["$scope","$state","$firebaseAuth","$firebaseArray",function(e,t,o,a){e.login=function(e){o().$signInWithPopup(e).then(function(e){var o=e.user,a=o.uid,r=o.displayName;console.log(e),console.log("User ID: "+a);var n=firebase.database().ref("users/"+a);n.once("value").then(function(e){if(e.exists())console.log("User already exists"),t.go("search");else{var a={displayName:r,photoUrl:o.photoURL};n.set(a,function(){console.log("New user "+r+" added")})}t.go("search")})})["catch"](function(e){console.error("Authentication failed:",e)})}}]),site.controller("SearchController",["$scope","$state","$firebaseAuth","$firebaseArray","MatchDetails",function(e,t,o,a,r){function n(o){var a=e.searches,n=null;for(i=0;i<a.length;i++){var l=o.coords.latitude,u=o.coords.longitude,h=s(l,u,a[i].location[0],a[i].location[1]);h<=e.search.maxRadius&&(console.log("Found a match! Distance = "+h+" < maxRadius = "+e.search.maxRadius),(null==n||h<n.distance)&&(console.log("Updated min distance match"),n=a[i],n.distance=h))}if(null!=n){var d={latitude:n.location[0],longitude:n.location[1],maxRadius:e.search.maxRadius,activeId:n.$id,expireDate:e.search.waitMins};r.setData(d),t.go("result")}else console.log("No matches found"),c(l,u)}function s(e,t,o,a){var r=6371e3,n=(o-e)*Math.PI/180,s=(a-t)*Math.PI/180,i=.5-Math.cos(n)/2+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*(1-Math.cos(s))/2,c=2*r*Math.asin(Math.sqrt(i));return c}function c(t,a){var r={userId:o().$getAuth().uid,numPeople:e.search.numPeople,maxRadius:e.search.maxRadius,location:[t,a]};l.push(r,function(){console.log("Added search")})}var l=firebase.database().ref("active-searches");e.searches=a(l),e.search={numPeople:1,maxRadius:5e3,waitMins:5},e.submit=function(){navigator.geolocation?(console.log("Has geolocation"),navigator.geolocation.getCurrentPosition(n)):console.log("Error: couldn't get current location")}}]),site.controller("ResultController",["$scope","$firebaseArray","MatchDetails","YelpService",function(e,t,o,a){function r(o){var a=firebase.database().ref("active-searches");e.searches=t(a),e.searches.length>0&&e.searches.$remove(e.searches.$getRecord(o)).then(function(){console.log("Removed by ID")})}function n(e){var t=firebase.database().ref("active-matches");t.push(e,function(){console.log("Added match")})}a.searchYelp(o.getLatitude(),o.getLongitude(),o.getMaxRadius(),function(t){console.log("Got Yelp results"),t.businesses.length>0&&(e.bestMatch=t.businesses[0],e.bestMatch.activeId=o.getActiveId(),r(o.getActiveId()),n(e.bestMatch),console.log(e.bestMatch))})}]),site.controller("CountdownController",["$scope","$state","MatchDetails",function(e,t,o){function a(e){var t=Date.parse(e)-Date.parse(new Date),o=Math.floor(t/1e3%60),a=Math.floor(t/1e3/60%60),r=Math.floor(t/36e5%24),n=Math.floor(t/864e5);return{total:t,days:n,hours:r,minutes:a,seconds:o}}function r(e,t){function o(){var e=a(t);n.innerHTML=("0"+e.minutes).slice(-2),s.innerHTML=("0"+e.seconds).slice(-2),e.total<=0&&clearInterval(i)}var r=document.getElementById(e),n=r.querySelector(".minutes"),s=r.querySelector(".seconds");o();var i=setInterval(o,1e3)}var n=new Date(Date.parse(new Date)+60*o.getExpireDate()*1e3);r("clockdiv",n)}]),site.service("MatchDetails",function(){var e,t,o,a,r;return{getLatitude:function(){return e},getLongitude:function(){return t},getMaxRadius:function(){return o},getActiveId:function(){return a},getExpireDate:function(){return r},setData:function(n){e=n.latitude,t=n.longitude,o=n.maxRadius,a=n.activeId,r=n.expireDate}}}),site.factory("YelpService",function(e,t){function o(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<32;o++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}return{searchYelp:function(a,r,n,s){var i=e.defer(),c="GET",l="http://api.yelp.com/v2/search",u={oauth_consumer_key:"gol1ZEbWq_Zj5CLA1YJbJg",oauth_token:"z4519RcSXpdN9g5kIwCJ6G5Iqh1cuC8e",oauth_signature_method:"HMAC-SHA1",oauth_timestamp:(new Date).getTime(),oauth_nonce:o(),ll:a+","+r,callback:"angular.callbacks._0",term:"food",radius_filter:n},h="qY__w0zPqYqu0BC6yQ38plyOYtI",d="qWmSq31mLiuq9NSqtPnrA7tc_N4",f=oauthSignature.generate(c,l,u,h,d,{encodeSignature:!1});return u.oauth_signature=f,t.jsonp(l,{params:u}).success(s),i.promise}}});