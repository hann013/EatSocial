var site=angular.module("site",["ui.router","firebase"]);site.config(function(e,t){t.otherwise("/"),e.state("home",{url:"/",templateUrl:"views/home.html",controller:"LoginController"}).state("results",{url:"/results",templateUrl:"views/results.html",controller:"SearchController"}).state("profile",{url:"/profile",templateUrl:"views/profile.html"}).state("countdown",{url:"/countdown",templateUrl:"views/countdown.html"})}),site.controller("siteCtrl",["$scope","$window","$state",function(e,t,o){e.gotoProfile=function(){o.go("")},$(document).ready(function(){})}]),site.controller("LoginController",["$scope","$firebaseAuth","$firebaseArray","$state",function(e,t,o,a){e.login=function(e){t().$signInWithPopup(e).then(function(e){var t=e.user,o=t.uid,n=t.displayName;console.log(e),console.log("User ID: "+o);var r=firebase.database().ref("users/"+o);r.once("value").then(function(e){if(e.exists())console.log("User already exists"),a.go("results");else{var o={displayName:n,photoUrl:t.photoURL};r.set(o,function(){console.log("New user "+n+" added")})}a.go("results")})})["catch"](function(e){console.error("Authentication failed:",e)})}}]),site.controller("SearchController",["$scope","$firebaseAuth","$firebaseArray","MatchDetails",function(e,t,o,a){function n(t){var o=e.active,n=null;for(i=0;i<o.length;i++){var l=t.coords.latitude,c=t.coords.longitude,u=r(l,c,o[i].location[0],o[i].location[1]);u<=e.search.maxRadius&&(console.log("Found a match! Distance = "+u+" < maxRadius = "+e.search.maxRadius),(null==n||u<n.distance)&&(console.log("Updated min distance match"),n=o[i],n.distance=u))}null!=n?(a.setLatitude(n.location[0]),a.setLongitude(n.location[1]),a.setMaxRadius(e.search.maxRadius)):(console.log("No matches found"),s(l,c))}function r(e,t,o,a){var n=6371e3,r=(o-e)*Math.PI/180,i=(a-t)*Math.PI/180,s=.5-Math.cos(r)/2+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*(1-Math.cos(i))/2,l=2*n*Math.asin(Math.sqrt(s));return l}function s(o,a){var n=firebase.database().ref("active-searches"),r={userId:t().$getAuth().uid,numPeople:e.search.numPeople,maxRadius:e.search.maxRadius,location:[o,a]};n.push(r,function(){console.log("Added search")})}var l=firebase.database().ref("active-searches");e.active=o(l),e.search={numPeople:1,maxRadius:5e3,waitMins:5},e.validate=function(){},e.submit=function(){navigator.geolocation?(console.log("Has geolocation"),navigator.geolocation.getCurrentPosition(n)):console.log("Error: couldn't get current location")}}]),site.controller("MatchController",["$scope","$firebaseAuth","$firebaseArray","MatchDetails","YelpService",function(e,t,o,a,n){n.searchYelp(a.getLatitude(),a.getLongitude(),a.getMaxRadius(),function(e){console.log("done"),console.log(e[0])})}]),site.service("MatchDetails",function(){var e,t,o;return{getLatitude:function(){return e},setLatitude:function(t){e=t},getLongitude:function(){return t},setLongitude:function(e){t=e},getMaxRadius:function(){return o},setMaxRadius:function(e){o=e}}}),site.factory("YelpService",function(e,t){function o(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=0;o<32;o++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}return{searchYelp:function(a,n,r,i){var s=e.defer(),l="GET",c="http://api.yelp.com/v2/search",u={oauth_consumer_key:"gol1ZEbWq_Zj5CLA1YJbJg",oauth_token:"z4519RcSXpdN9g5kIwCJ6G5Iqh1cuC8e",oauth_signature_method:"HMAC-SHA1",oauth_timestamp:(new Date).getTime(),oauth_nonce:o(),ll:a+","+n,callback:"angular.callbacks._0",term:"food",radius_filter:r},h="qY__w0zPqYqu0BC6yQ38plyOYtI",d="qWmSq31mLiuq9NSqtPnrA7tc_N4",f=oauthSignature.generate(l,c,u,h,d,{encodeSignature:!1});return u.oauth_signature=f,t.jsonp(c,{params:u}).success(i),s.promise}}});